<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tic Tac Toe Multiplayer</title>

<style>
  body {
    font-family: system-ui, sans-serif;
    background: #111;
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
  }

  .game {
    text-align: center;
  }

  .board {
    display: grid;
    grid-template-columns: repeat(3, 100px);
    gap: 10px;
    margin: 20px auto;
  }

  .cell {
    width: 100px;
    height: 100px;
    background: #222;
    font-size: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    user-select: none;
  }

  .cell:hover {
    background: #333;
  }

  .win {
    background: #444 !important;
  }

  .status {
    margin-top: 10px;
    min-height: 24px;
  }
</style>
</head>
<body>

<div class="game">
  <h1>Tic Tac Toe</h1>
  <div class="board" id="board"></div>
  <div class="status" id="status">Loadingâ€¦</div>
</div>

<!-- ===== STEP 1: BASIC JS CHECK ===== -->
<script>
  alert("JS LOADED");
  console.log("SCRIPT STARTED");
</script>

<!-- ===== STEP 2: FIREBASE SDKs ===== -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* =========================================================
   STEP 3: FIREBASE CONFIG (REPLACE VALUES ONLY)
   ========================================================= */

const firebaseConfig = {
  apiKey: "PASTE_YOURS",
  authDomain: "PASTE_YOURS",
  databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
  projectId: "PASTE_YOURS",
  storageBucket: "PASTE_YOURS",
  messagingSenderId: "PASTE_YOURS",
  appId: "PASTE_YOURS"
};

firebase.initializeApp(firebaseConfig);
console.log("Firebase initialized");

const db = firebase.database();

/* =========================================================
   STEP 4: CONNECTION CHECK
   ========================================================= */

firebase.database().ref(".info/connected").on("value", snap => {
  console.log("Firebase connected:", snap.val());
});

/* =========================================================
   STEP 5: ROOM SETUP
   ========================================================= */

const params = new URLSearchParams(location.search);
const room =
  params.get("room") || Math.random().toString(36).slice(2, 7);

history.replaceState({}, "", "?room=" + room);
console.log("Room ID:", room);

const roomRef = db.ref("rooms/" + room);

/* =========================================================
   STEP 6: GAME STATE
   ========================================================= */

let mySymbol = null;
let board = Array(9).fill("");
let turn = "X";
let winner = null;
let winningLine = [];

const boardEl = document.getElementById("board");
const statusEl = document.getElementById("status");

/* =========================================================
   STEP 7: CREATE BOARD UI
   ========================================================= */

for (let i = 0; i < 9; i++) {
  const cell = document.createElement("div");
  cell.className = "cell";
  cell.onclick = () => makeMove(i);
  boardEl.appendChild(cell);
}

console.log("Board created");

/* =========================================================
   STEP 8: JOIN ROOM
   ========================================================= */

roomRef.child("players").once("value", snap => {
  const players = snap.val() || {};
  const count = Object.keys(players).length;

  console.log("Players in room:", count);

  if (count >= 2) {
    statusEl.textContent = "Room full";
    return;
  }

  mySymbol = count === 0 ? "X" : "O";
  roomRef.child("players").push(mySymbol);

  statusEl.textContent = "You are " + mySymbol;
  console.log("Assigned symbol:", mySymbol);
});

/* =========================================================
   STEP 9: LISTEN FOR GAME UPDATES
   ========================================================= */

roomRef.on("value", snap => {
  const data = snap.val();
  if (!data) return;

  board = data.board || board;
  turn = data.turn || turn;
  winner = data.winner || null;
  winningLine = data.winningLine || [];

  updateUI();
  console.log("Game updated:", data);
});

/* =========================================================
   STEP 10: GAME LOGIC
   ========================================================= */

function checkWinner(b) {
  const wins = [
    [0,1,2], [3,4,5], [6,7,8],
    [0,3,6], [1,4,7], [2,5,8],
    [0,4,8], [2,4,6]
  ];

  for (const line of wins) {
    const [a, b1, c] = line;
    if (b[a] && b[a] === b[b1] && b[a] === b[c]) {
      return { winner: b[a], line };
    }
  }

  if (b.every(cell => cell !== "")) {
    return { winner: "draw", line: [] };
  }

  return null;
}

function makeMove(i) {
  console.log("Cell clicked:", i);

  if (!mySymbol) return;
  if (winner) return;
  if (board[i] !== "") return;
  if (turn !== mySymbol) return;

  board[i] = mySymbol;
  turn = mySymbol === "X" ? "O" : "X";

  const result = checkWinner(board);
  if (result) {
    winner = result.winner;
    winningLine = result.line;
  }

  roomRef.update({ board, turn, winner, winningLine });
}

/* =========================================================
   STEP 11: UPDATE UI
   ========================================================= */

function updateUI() {
  [...boardEl.children].forEach((cell, i) => {
    cell.textContent = board[i];
    cell.classList.toggle("win", winningLine.includes(i));
  });

  if (winner === "draw") {
    statusEl.textContent = "Draw";
    return;
  }

  if (winner) {
    statusEl.textContent =
      winner === mySymbol ? "You won ðŸŽ‰" : "You lost";
    return;
  }

  statusEl.textContent =
    turn === mySymbol ? "Your turn" : "Opponent's turn";
}
</script>

</body>
</html>
